<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Educine.in - QR Code Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: #0f0f11;
        color: #ffffff;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .scanner-container {
        background: linear-gradient(135deg, #1a1a1d, #1f1f22);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        padding: 2rem;
        width: 100%;
        max-width: 28rem;
        box-shadow: 0 12px 35px -10px rgba(136, 63, 249, 0.25);
      }

      #qr-video {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 1rem;
      }

      #qr-canvas {
        display: none;
      }

      .btn-scan {
        background: linear-gradient(135deg, #ff007a 0%, #883ff9 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
      }

      .btn-scan:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(136, 63, 249, 0.25);
      }

      .status-message {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
      }

      .success {
        background-color: rgba(74, 222, 128, 0.2);
        color: #4ade80;
        border: 1px solid #4ade80;
      }

      .error {
        background-color: rgba(248, 113, 113, 0.2);
        color: #f87171;
        border: 1px solid #f87171;
      }

      .info {
        background-color: rgba(96, 165, 250, 0.2);
        color: #60a5fa;
        border: 1px solid #60a5fa;
      }
      .already-checked {
        background-color: rgba(234, 179, 8, 0.2);
        color: #eab308;
        border: 1px solid #eab308;
      }
      /* Add to your existing CSS */
      #result-container {
        transition: all 0.3s ease;
      }

      .participant-detail {
        display: grid;
        grid-template-columns: 80px 1fr;
        gap: 8px;
        margin-bottom: 6px;
      }

      .detail-label {
        color: #94a3b8;
        text-align: right;
      }

      .detail-value {
        color: #ffffff;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div class="scanner-container">
      <h1 class="text-2xl font-bold text-center mb-4">Educine QR Scanner</h1>
      <div class="mb-4">
        <video id="qr-video" playsinline></video>
        <canvas id="qr-canvas"></canvas>
      </div>
      <button id="scan-btn" class="btn-scan">Start Scanner</button>
      <div id="status-message" class="status-message hidden"></div>
      <div id="result-container" class="mt-4 hidden">
        <div class="bg-gray-800 rounded-lg p-4">
          <h3 class="font-semibold mb-2">Participant Details:</h3>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="text-gray-400">ID:</div>
            <div id="scan-id" class="font-medium"></div>
            <div class="text-gray-400">Name:</div>
            <div id="scan-name" class="font-medium"></div>
          </div>
          <button id="confirm-btn" class="btn-scan mt-4">
            Confirm Attendance
          </button>
        </div>
      </div>
    </div>

    <script>
      const video = document.getElementById("qr-video");
      const canvas = document.getElementById("qr-canvas");
      const scanBtn = document.getElementById("scan-btn");
      const statusMessage = document.getElementById("status-message");
      const resultContainer = document.getElementById("result-container");
      const confirmBtn = document.getElementById("confirm-btn");

      let scannerActive = false;
      let currentScanResult = null;
      let stream = null;

      // Initialize scanner
      scanBtn.addEventListener("click", async () => {
        if (scannerActive) {
          stopScanner();
          scanBtn.textContent = "Start Scanner";
          scannerActive = false;
          return;
        }

        try {
          // Clear any previous messages
          statusMessage.classList.add("hidden");

          // Request camera access with better constraints
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 1280, max: 1920 },
              height: { ideal: 720, max: 1080 },
              frameRate: { ideal: 30 },
            },
          });

          video.srcObject = stream;
          await video.play();

          // Add event listener for loadedmetadata
          video.addEventListener("loadedmetadata", () => {
            scannerActive = true;
            scanBtn.textContent = "Stop Scanner";
            showStatus("Scanner started. Point camera at QR code.", "info");
            resultContainer.classList.add("hidden");
            scanForQR();
          });
        } catch (err) {
          console.error("Camera Error:", err);
          let errorMsg = "Error accessing camera.";

          if (err.name === "NotAllowedError") {
            errorMsg = "Camera permission denied. Please allow camera access.";
          } else if (err.name === "NotFoundError") {
            errorMsg = "No camera found. Please check your device.";
          } else if (err.name === "NotSupportedError") {
            errorMsg = "Camera not supported in this browser.";
          }

          showStatus(errorMsg, "error");
        }
      });

      function stopScanner() {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }
        video.srcObject = null;
      }

      function scanForQR() {
        if (!scannerActive) return;

        const canvasElement = document.getElementById("qr-canvas");
        const canvasContext = canvasElement.getContext("2d");

        // Check if video is ready and has dimensions
        if (video.readyState >= video.HAVE_METADATA && video.videoWidth > 0) {
          // Set canvas dimensions to match video
          canvasElement.width = video.videoWidth;
          canvasElement.height = video.videoHeight;

          // Draw video frame to canvas
          canvasContext.drawImage(
            video,
            0,
            0,
            canvasElement.width,
            canvasElement.height
          );

          // Get image data with proper error handling
          try {
            const imageData = canvasContext.getImageData(
              0,
              0,
              canvasElement.width,
              canvasElement.height
            );
            const code = jsQR(
              imageData.data,
              imageData.width,
              imageData.height,
              {
                inversionAttempts: "dontInvert",
              }
            );

            if (code) {
              console.log("QR Code detected:", code.data);
              stopScanner();
              scannerActive = false;
              scanBtn.textContent = "Start Scanner";
              currentScanResult = code.data;

              // Validate QR code format before proceeding
              if (isValidQRCode(code.data)) {
                processQRResult(code.data);
              } else {
                showStatus(
                  "Invalid QR code format. Expected format: ESU####, EJO####, or ESP####",
                  "error"
                );
                // Auto-restart scanner after 3 seconds
                setTimeout(() => {
                  if (!scannerActive) {
                    scanBtn.click();
                  }
                }, 3000);
              }
              return;
            }
          } catch (e) {
            console.error("Scan Error:", e);
          }
        }

        // Continue scanning
        requestAnimationFrame(scanForQR);
      }

      // Validate QR code format
      function isValidQRCode(code) {
        // Check if the code starts with one of the expected prefixes
        return /^(ESU|EJO|ESP)\d+$/.test(code);
      }

      // Process QR code result
      function processQRResult(data) {
        // Trim any whitespace that might have been captured
        data = data.trim();

        // First show the ID while we fetch additional details
        document.getElementById("scan-id").textContent = data;
        document.getElementById("scan-name").textContent = "Loading...";
        resultContainer.classList.remove("hidden");

        // Fetch participant details from the server
        fetch(
          `https://script.google.com/macros/s/AKfycbzocHy05SYImT29VeSFgTX7qBail6MjjIlNFq2heKs8piOADpPPJkwD0VfX7L-fRiyH/exec?action=checkAttendance&id=${data}`
        )
          .then((response) => response.json())
          .then((result) => {
            console.log("API response:", result);

            if (result.success || result.alreadyCheckedIn) {
              document.getElementById("scan-name").textContent =
                result.name || "Not available";

              if (result.alreadyCheckedIn) {
                showStatus(
                  `${result.name} already checked in at ${new Date(
                    result.timestamp
                  ).toLocaleString()}`,
                  "already-checked"
                );
              } else {
                showStatus(`Ready to check in: ${result.name}`, "info");
              }
            } else {
              document.getElementById("scan-name").textContent =
                "Error loading details";
              showStatus(result.message, "error");
            }
          })
          .catch((error) => {
            console.error("API Error:", error);
            document.getElementById("scan-name").textContent =
              "Error loading details";
            showStatus(
              "Failed to load participant details. Check network connection.",
              "error"
            );
          });
      }

      // Update the confirmation handler
      confirmBtn.addEventListener("click", async () => {
        if (!currentScanResult) return;

        confirmBtn.disabled = true;
        confirmBtn.textContent = "Processing...";

        try {
          console.log("Sending attendance request for ID:", currentScanResult);

          // First make the POST request to mark attendance
          const response = await fetch(
            "https://script.google.com/macros/s/AKfycbzocHy05SYImT29VeSFgTX7qBail6MjjIlNFq2heKs8piOADpPPJkwD0VfX7L-fRiyH/exec",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                action: "markAttendance",
                id: currentScanResult,
              }),
            }
          );

          // Try to parse the response (works if CORS is properly configured)
          let result;
          try {
            result = await response.json();
            console.log("Attendance response:", result);
          } catch (e) {
            console.error("Error parsing response:", e);
            // If parsing fails (due to no-cors), make a GET request to verify
            const checkResponse = await fetch(
              `https://script.google.com/macros/s/AKfycbzocHy05SYImT29VeSFgTX7qBail6MjjIlNFq2heKs8piOADpPPJkwD0VfX7L-fRiyH/exec?action=checkAttendance&id=${currentScanResult}`
            );
            result = await checkResponse.json();
            console.log("Check response:", result);
          }

          // Handle the result
          if (result.alreadyCheckedIn) {
            showStatus(
              `${result.name} already checked in at ${new Date(
                result.timestamp
              ).toLocaleString()}`,
              "already-checked"
            );
          } else if (result.success) {
            const checkInTime = result.timestamp
              ? new Date(result.timestamp).toLocaleString()
              : "just now";
            showStatus(
              `Successfully checked in ${result.name} at ${checkInTime}`,
              "success"
            );
          } else {
            showStatus(`Error: ${result.message}`, "error");
          }

          // Reset the scanner
          setTimeout(() => {
            resultContainer.classList.add("hidden");
            currentScanResult = null;
            confirmBtn.disabled = false;
            confirmBtn.textContent = "Confirm Attendance";
            scanBtn.click(); // Restart scanner
          }, 3000);
        } catch (error) {
          console.error("Error:", error);
          showStatus("Failed to mark attendance. Please try again.", "error");
          confirmBtn.disabled = false;
          confirmBtn.textContent = "Confirm Attendance";
        }
      });

      function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = `status-message ${type}`;
        statusMessage.classList.remove("hidden");

        // Auto-hide after delay
        const delay = type === "error" ? 8000 : 5000;
        const timer = setTimeout(() => {
          statusMessage.classList.add("hidden");
        }, delay);

        // Clear timeout if new message comes in
        if (window.statusTimer) {
          clearTimeout(window.statusTimer);
        }
        window.statusTimer = timer;
      }

      // Clean up when page is unloaded
      window.addEventListener("beforeunload", () => {
        stopScanner();
      });
    </script>
  </body>
</html>
